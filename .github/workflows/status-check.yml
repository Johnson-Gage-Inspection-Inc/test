name: PR Check

on:
  pull_request:
    branches:
      - main

jobs:
  load-env:
    runs-on: ubuntu-latest
    outputs:
      sop_id: ${{ steps.export.outputs.SOP_ID }}
      doc_id: ${{ steps.export.outputs.DOC_ID }}
      doc_title: ${{ steps.export.outputs.DOC_TITLE }}
      doc_details: ${{ steps.export.outputs.DOC_DETAILS }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Load .env and Export Variables
        id: export
        run: |
          set -o allexport
          source .env
          set +o allexport
          for var in $(cat .env | grep -o '^[^#]*' | cut -d= -f1); do
            echo "$var=${!var}" >> $GITHUB_ENV
            echo "$var=${!var}" >> $GITHUB_OUTPUT
          done

      - name: Debug Environment Variables
        run: env | sort  # âœ… Print all env variables to debug

  validate:
    needs: load-env
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Scoped Env Debugging
        uses: muchobien/scoped-env@v1.1.1
        with:
          secrets: ${{ toJson(secrets) }}  # Dumps all secrets for debugging
          scope: "all"  # Exposes everything
          includes: "SOP_ID,DOC_ID,DOC_TITLE,DOC_DETAILS"  # Ensure these variables are included
          overrides: true  # Ensures we override existing variables
          exporters: "env,output"  # Ensures variables are available

      - name: Debug Scoped Variables
        run: |
          echo "SOP_ID: $SOP_ID"
          echo "DOC_ID: $DOC_ID"
          echo "DOC_TITLE: $DOC_TITLE"
          echo "DOC_DETAILS: $DOC_DETAILS"
      
  check:
    uses: Johnson-Gage-Inspection-Inc/ci-scripts/.github/workflows/qualer-check.yml@main
    with:
      repo_name: Johnson-Gage-Inspection-Inc/test
      sop_id: ${{ needs.load-env.outputs.sop_id }}
      doc_id: ${{ needs.load-env.outputs.doc_id }}
      doc_title: ${{ needs.load-env.outputs.doc_title }}
      doc_details: ${{ needs.load-env.outputs.doc_details }}
    secrets:
      QUALER_EMAIL: ${{ secrets.QUALER_EMAIL }}
      QUALER_PASSWORD: ${{ secrets.QUALER_PASSWORD }}
