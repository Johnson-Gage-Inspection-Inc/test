name: Upload & Release on Merge

on:
  push:
    branches:
      - main

jobs:
  load-env:
    runs-on: ubuntu-latest
    outputs:
      sop_id: ${{ steps.export.outputs.SOP_ID }}
      doc_id: ${{ steps.export.outputs.DOC_ID }}
      doc_title: ${{ steps.export.outputs.DOC_TITLE }}
      doc_details: ${{ steps.export.outputs.DOC_DETAILS }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Load .env and Export Variables
        id: export
        run: |
          export $(grep -v '^#' .env | xargs)
          echo "SOP_ID=${SOP_ID}" >> $GITHUB_ENV
          echo "DOC_ID=${DOC_ID}" >> $GITHUB_ENV
          echo "DOC_TITLE=${DOC_TITLE}" >> $GITHUB_ENV
          echo "DOC_DETAILS=${DOC_DETAILS}" >> $GITHUB_ENV

          # Store them as outputs for next jobs
          echo "SOP_ID=${SOP_ID}" >> $GITHUB_OUTPUT
          echo "DOC_ID=${DOC_ID}" >> $GITHUB_OUTPUT
          echo "DOC_TITLE=${DOC_TITLE}" >> $GITHUB_OUTPUT
          echo "DOC_DETAILS=${DOC_DETAILS}" >> $GITHUB_OUTPUT

  check-env:
    needs: load-env
    runs-on: ubuntu-latest
    steps:
      - name: Display env variables
        run: |
          echo "SOP_ID: ${{ needs.load-env.outputs.sop_id }}"
          echo "DOC_ID: ${{ needs.load-env.outputs.doc_id }}"
          echo "DOC_TITLE: ${{ needs.load-env.outputs.doc_title }}"
          echo "DOC_DETAILS: ${{ needs.load-env.outputs.doc_details }}"

  upload:
    needs: load-env
    uses: Johnson-Gage-Inspection-Inc/ci-scripts/.github/workflows/qualer-upload-release.yml@main
    with:
      repo_name: Johnson-Gage-Inspection-Inc/test
      branch: main
      sop_id: ${{ needs.load-env.outputs.sop_id }}
      doc_id: ${{ needs.load-env.outputs.doc_id }}
      doc_title: ${{ needs.load-env.outputs.doc_title }}
      doc_details: ${{ needs.load-env.outputs.doc_details }}
    secrets:
      QUALER_EMAIL: ${{ secrets.QUALER_EMAIL }}
      QUALER_PASSWORD: ${{ secrets.QUALER_PASSWORD }}
